#!/usr/bin/env bash
#    _____ _     ____  ____  ____  ____  _____
#   /    // \   /  _ \/  __\/  _ \/  __\/__ __\
#   |  __\| |   | / \||  \/|| / \||  \/|  / \
#   | |   | |_/\| |-|||  __/| \_/||    /  | |
#   \_/   \____/\_/ \|\_/   \____/\_/\_\  \_/

# Widget selection
#--------------------------------------------------------------------------------

# The widget array determines which widgets are included in the status bar.
# Each included widget needs to be defined below by a function with the same name.

widgets=(
    transmission # torrenting status
    playercontrol # status of currently open media player (pause/play)
    appointments # show time of current/next appointment.
    services # clickable icon to start/stop services
    bluetooth # show ïŠ“ if bluetooth is connected, ïŠ” otherwise
    syncthing # show icon if syncthing service is active
    sshd # show icon if sshd service is active
    sshtunnel # show icon if sshtunnel service is active
    jellyfin # show icon if jellyfin service is active
    jupyterhub # show icon if jupyterhub service is active
    openvpn # show icon if openvpn is connected
    openconnect # show icon if openconnect is connected
    cups # show icon if the CUPS printer service is running
    gpg # show icon if a gpg key password is currently cached
    email # number of unread emails
    pacmanstatus # number of updatable packages
    volume # volume (managed by pulseaudio)
    brightness # brightness
    battery # shows battery percentage left
    alpha # shows terminal transparency (managed by Xresources, enabled by picom)
    # memory # uses same icon as disk. Know which one is which.
    # cpu # shows cpu usage
    # disk # uses same icon as memory. Know which one is which.
    weather # reads from cache! Make sure you have it regularly update somewhere else.
    calendar # shows the current date
    clock # shows a clock
    # localip # same info after clicking network icon
    # publicip # introduces lag due to curl call
    network # shows a clickable globe icon.
    # wifi # same info after clicking network icon
)

# Parse arguments
#--------------------------------------------------------------------------------

usage(){
    echo "usage: dwm_status [widget-index] [mouse-button 1|2|3|4|5]"
    exit 0
}

([ "$1" == "-h" ] || [ "$1" == "--help" ]) && usage

WIDGET="$1"
[ -n "$1" -a "$1" -ge 0 2>/dev/null ] || WIDGET=""

BUTTON="$2"

mkdir -p $HOME/.cache

# kill all currently running dwm_status processes
# ps aux | grep -ie dwm_status | grep -v grep | grep -v vim | awk '{print $2}' | sed "/$$/d" | xargs kill -9 &


# Status Command
#--------------------------------------------------------------------------------

# this is the command that pastes the widgets (defined below) together into the
# status bar of dwm (by using xsetroot). The delimiter cannot be changed for
# now, as (my fork of) dwm uses the same delimiter to figure out which widget
# was clicked.

status(){
    s=""
    i=0
    for func in "${widgets[@]}"
    do
        out=$($func)
        if [ ! -z "$out" ]; then
            if [[ $WIDGET == $i && $BUTTON ]]; then
                $func$BUTTON &> /dev/null || exit 1
                out=$($func)
            fi
            s="$s $out#"
            i=$((i+1))
        fi
    done
    delim=$(printf "\x$(printf %x 32)") # 32: standard space (make sure the asci code matches with the one in dwm config.h !)
    unicodespace="â€€" # unicode space U+2000 (replace all normal spaces by this one bc normal space is reserved for separator)
    s="$(echo $s | sed "s/[ ]/$unicodespace/g" | sed "s/\#/$delim/g" )"
    xsetroot -name "$s" &> /dev/null
    echo $s > $HOME/.cache/dwm_status 2> /dev/null
}


# Helper functions
#--------------------------------------------------------------------------------

notifyservice(){
    name=$1
    if systemctl is-active $name &> /dev/null; then
        notify-send "$name service" "\n$(systemctl status $name | grep Active | sed 's/^.*Active://g' | sed 's/\ (running)//g')\n\nmiddle click to stop\n\n[ ï…‘ + ïŒ½ + s: toggle any service ]"
    else
        notify-send "$name service" "\n$(systemctl status $name | grep Active | sed 's/^.*Active://g' | sed 's/\ (dead)//g')\n\nmiddle click to start\n\n[ ï…‘ + ïŒ½ + s: toggle any service ]"
    fi
}

toggleservice(){
    name=$1
    if systemctl is-active $name &> /dev/null; then
        sudo -A -p "[sudo] password to stop $name.service" systemctl stop $name
    else
        sudo -A -p "[sudo] password to restart $name.service" systemctl start $name
    fi
}


# Widgets
#--------------------------------------------------------------------------------

# -----------

alpha(){ # window transparency
    pidof picom > /dev/null
    if [ $? -eq 0 ]; then
        echo Î± $($HOME/.scripts/x/alpha get)%
    else
        echo Î± -
    fi
}
alpha1(){ # mouse-button 1 action for alpha widget
    notify-send "Window transparency" "\n\nï…‘ + a: decrease transparency\nï…‘ + ïŒ½ + a: increase transparency"
}

# -----------

battery(){ # battery
    pct=$(cat /sys/class/power_supply/BAT*/capacity | head -1)
    [ -z $pct ] && return
    batstatus=$(cat /sys/class/power_supply/BAT*/status | head -1)
    if [ "$batstatus" = "Discharging" ] &> /dev/null; then
        [ "$pct" -gt 90 ] && echo "ï‰€â€$pct%" && return
        [ "$pct" -gt 60 ] && echo "ï‰â€$pct%" && return
        [ "$pct" -gt 30 ] && echo "ï‰‚â€$pct%" && return
        [ "$pct" -gt  5 ] && echo "ï‰ƒâ€$pct%" && return
        echo "ï‰„$pct\%" && return
    fi
    echo "ïŠ $pct%"
}
battery1(){ # mouse-button 1 action for battery widget
    notify-send "$(acpi -b)"
}

# -----------

brightness(){ # screen brightness
    dir=/sys/class/backlight/intel_backlight
    if [ ! -d $dir ]; then
        echo ""
        return
    fi
    max_brightness=$(cat $dir/max_brightness)
    brightness=$(cat $dir/brightness)
    python -c "print('ï†… %.0f'%(100*$brightness/$max_brightness)+'%')" # â˜€ï¸
}
brightness1(){ # mouse-button 1 action for brightness widget
    dir=/sys/class/backlight/intel_backlight
    max_brightness=$(cat $dir/max_brightness)
    brightness=$(cat $dir/brightness)
    brightness=$(python -c "print('%.0f'%(100*$brightness/$max_brightness)+'%')")
    notify-send "Screen brightness [$brightness]" "ï…‘ + F11: decrease brightness\nï…‘ + F12: increase brightness"
}

# -----------

bluetooth(){ # bluetooth
    [ ! -d /sys/class/bluetooth ] && echo "" && return
    device=$(echo exit | bluetoothctl | grep -o -m 1 "\b\[.*\]" | sed "s/.*\[\(.*\)\].*/\1/g")
    [ "$device" == "bluetooth" ] && echo ïŠ” || echo ïŠ“
}
bluetooth1(){ # mouse-button 1 action for bluetooth widget
    device=$(echo exit | bluetoothctl | grep -o -m 1 "\b\[.*\]" | sed "s/.*\[\(.*\)\].*/\1/g")
    if [[ $device == bluetooth ]]; then
        notify-send Bluetooth "\ndisconnected\n\nmiddle click / ï…‘ + b to connect"
    else
        notify-send Bluetooth "\nconnected to $device\n\nmiddle click / ï…‘ + b to disconnect"
    fi
}
bluetooth2(){ # mouse-button 1 action for bluetooth widget
    dmenu_bluetooth
}

# -----------
appointments(){
    hm=$(grep $(date +'%m/%d/%Y') $HOME/.calcurse/apts | sed 's/[^@]*@\ \([0-9]*:[0-9]*\)[^@]*@[^|]*|/\1: /g' | grep $(date +'%H') | sed 's/^\([0-9][0-9]:[0-9][0-9]\).*/\1/g')
    if [ -z "$hm" ]; then
        next=$(calcurse --next | sed '/next.*/d')
        [ -z "$next" ] && return
        H=$(date +'%H')
        M=$(date +'%M')
        h=$(echo $next | sed 's/^[^0-9]*\([0-9]*\).*/\1/g')
        m=$(echo $next | sed 's/^[^:]*:[^0-9]*\([0-9]*\).*/\1/g')
        m=$((M+m))
        h=$((H+h))
        while [ "$m" -ge 60 ]; do
            m=$((m-60))
            h=$((h+1))
        done
        m=$(echo "0$m" | sed 's/^0\([0-9][0-9]$\)/\1/g')
        while [ "$h" -ge 24 ]; do
            h=$((h-24))
        done
        h=$(echo "0$h" | sed 's/^0\([0-9][0-9]$\)/\1/g')
        hm=$h:$m
    fi
    echo ï‰¶ $hm
}
appointments1(){
    apt1=$(grep $(date +'%m/%d/%Y') $HOME/.calcurse/apts | sed 's/[^@]*@\ \([0-9]*:[0-9]*\)[^@]*@[^|]*|/\1: /g' | grep $(date +'%H') | sed 's/^[0-9][0-9]:[0-9][0-9]:\ //g')
    apt2=$(calcurse --next | sed '/next.*/d')
    echo $apt2 | grep "$apt1" &> /dev/null && apt1=""
    [ -z $apt1 ] || apt1="   [ now ] $apt1\n"
    notify-send "Appointment:" "$apt1$apt2\n\nmiddle click to open calcurse."
}
appointments2(){
    $TERMINAL -e calcurse
}

# -----------

calendar(){ # date
    date +'ï‰´  %Y-%m-%d' # ğŸ“…
}
calendar1(){ # mouse-button 1 action for date widget
    notify-send "$(date +'%A, %B %d')" "\n$(cal | sed "s/\<$(date +%-d)\>/ï„/g")"
}

# -----------

clock(){ # time
    date +'ï† %H:%M' # ğŸ•’
}
clock1(){ # mouse-button 1 action for time widget
    notify-send "Date: $(date)"
}

# -----------

cpu(){ # cpu
    read cpu a b c previdle rest < /proc/stat
    prevtotal=$((a+b+c+previdle))
    sleep 0.5
    read cpu a b c idle rest < /proc/stat
    total=$((a+b+c+idle))
    cpu=$((100*( (total-prevtotal) - (idle-previdle) ) / (total-prevtotal) ))
    echo "ï„ˆ $cpu%"
}
cpu1(){ # mouse-button 1 action for cpu widget
    notify-send "cpu"
}

# -----------

cups(){ # CUPS printer status
    systemctl is-active org.cups.cupsd &> /dev/null && echo ï€¯
}
cups1(){
    notifyservice org.cups.cupsd
}
cups2(){
    toggleservice org.cups.cupsd
}

# -----------

disk(){ # memory
    usage=$(df -h . | grep -v Filesystem | awk '{print $5}')
    echo "ïƒ‡ $usage"
}
disk1() { # mouse-button 1 action for memory widget
    notify-send "disk usage:" "$(df -h $HOME)"
}

# -----------

gpg(){ # cached gpg keys
    gpg-connect-agent 'keyinfo --list' /bye | grep "1 P" &> /dev/null
    [ $? -eq 0 ] && echo ï‰
}
gpg1(){ # mouse-button 1 to display cached keys
    key=$(gpg-connect-agent 'keyinfo --list' /bye | grep "1 P" | sed 's/.*KEYINFO\ *\([^\ !]*\).*/\1/g')
    notify-send "passwords cached for these gpg keys:" "$key\n\nmiddle click to empty cache"
}
gpg2(){ # mouse-button 2 to empty gpg password cache
    kill -SIGHUP $(pidof gpg-agent)
}


# -----------

jupyterhub(){ # jupyterhub status
    systemctl is-active jupyterhub &> /dev/null && echo î˜¼  #ğŸª
}
jupyterhub1(){ # mouse-button 1 action for jupyterhub widget
    notifyservice jupyterhub
}
jupyterhub2(){
    toggleservice jupyterhub
}

# -----------

jellyfin(){ # jupyterhub status
    systemctl is-active jellyfin &> /dev/null && echo ï² # ğŸ“º
}
jellyfin1(){ # mouse-button 1 action for jupyterhub widget
    notifyservice jellyfin
}
jellyfin2(){
    toggleservice jellyfin
}

# -----------

email(){ # number of unread emails
    [ -f $HOME/.msmtprc ] || return
    gpg-connect-agent 'keyinfo --list' /bye | grep "1 P" &> /dev/null
    if [ $? -eq 0 ]; then
        num_unread=$(find $HOME/.local/share/email/*/INBOX/new/ -type f | wc -l 2> /dev/null)
        echo "ïŒ» $num_unread"
    else
        echo "ïŒ» ïŒ­"
    fi
}
email1(){ # give more email info
    num_unread=$(find $HOME/.local/share/email/*/INBOX/new/ -type f | wc -l 2> /dev/null)
    gpg-connect-agent 'keyinfo --list' /bye | grep "1 P" &> /dev/null
    if [ $? -eq 0 ]; then
        notify-send "$num_unread unread emails" "\nmiddle click to sync now."
    else
        notify-send "emails not syncing." "\nmiddle click to unlock gpg key and sync now\n\n($num_unread unread emails)"
    fi
}
email2(){ # start syncing emails
    $HOME/.scripts/email/syncmail
}

# -----------

localip(){ # local ip address
    nmcli -a | grep inet4 | sed 's/^[^ ]*[ ]\([0-9]*\.[0-9]*\.[0-9]*\.[0-9]*\).*/\1/g'
}
localip1(){
    network1
}

# -----------

memory(){ # memory
    used=$(free | awk '/Mem/ {print $3 }')
    total=$(free | awk '/Mem/ {print $2 }')
    percentage=$(python -c "print(f'{100*$used/$total:.0f}%')")
    echo "ïƒ‡ $percentage"
}
memory1() { # mouse-button 1 action for memory widget
    mem=`free | awk '/Mem/ {printf "%d MiB/%d MiB\n", $3 / 1024.0, $2 / 1024.0 }'`
    notify-send "free memory" mem
}

# -----------

network(){
    echo ï°
}
network1(){
    notify-send "Network:" "connected to: $(wifi)\nlocal ip:     $(localip)\npublic ip:    $(publicip)"
}

# -----------

openconnect(){ # openconnect
    pidof openconnect &> /dev/null && echo ïª  #|| echo "ï‚œ"
}
openconnect1(){ # mouse-button 1 action for openconnect widget
    pidof openconnect &> /dev/null && notify-send "openconnect" "running.\n\nmiddle click to stop" || notify-send "openconnect" "stopped."
}
openconnect2(){ # mouse-button 1 action for openconnect widget
    pidof openconnect &> /dev/null && sudo -A killall openconnect
}

# -----------

openvpn(){ # openvpn
    systemctl is-active openvpn &> /dev/null && echo ïª  #|| echo "ï‚œ"
}
openvpn1(){ # mouse-button 1 action for openvpn widget
    notifyservice openvpn
}
openvpn2(){ # mouse-button 2 action for openvpn widget
    toggleservice openvpn
}

# -----------

pacmanstatus(){ # pacman
    num=$(pacman -Qu | wc -l)
    [[ $num > 0 ]] && echo ïº $num
}
pacmanstatus1(){ # pacman
    num=$(pacman -Qu | wc -l)
    notify-send "Pacman ($num)" "$num packages can be updated\n\nmiddle click to update [pacman -Syu]"
}
pacmanstatus2(){ # update packages
    sudo -A -p "[sudo] password for 'pacman -Syu'" $TERMINAL -n float -e pacman -Syu
}

# -----------

playercontrol(){ # toggle a service
    # the icon needs to be cached as sometimes playerctl gives Stopped when nothing has happened.
    previous_icon=$(cat $HOME/.cache/dwm_playercontrol)
    [ -z $previous_icon ] && previous_icon=ï‹
    icon=$(timeout 1s playerctl status 2> /dev/null | sed 's/Playing/ï‹/g' | sed 's/Paused/ïŒ/g' | sed "s/Stopped/$previous_icon/g") || icon=""
    echo $icon > $HOME/.cache/dwm_playercontrol
    echo $icon
}
playercontrol1(){ # toggle a service
    timeout 1s playerctl play-pause
    icon1=$(cat $HOME/.cache/dwm_playercontrol)
    [ "$icon1" = "ï‹" ] && icon2=ïŒ && notify-send "ïŒ"
    [ "$icon1" = "ïŒ" ] && icon2=ï‹ && notify-send "ï‹"
    echo $icon2 > $HOME/.cache/dwm_playercontrol
    sed -i "s/$icon1/$icon2/g" $HOME/.cache/dwm_status
    xsetroot -name "$(cat $HOME/.cache/dwm_status)"
}

# -----------

publicip(){ # local ip address
    curl -s https://ipinfo.io/ip
}
publicip1(){
    network1
}


# -----------

services(){ # toggle a service
    echo ï‚—
}
services1(){
    dmenu_services
}


# -----------

sshd(){ # ssh daemon
    systemctl is-active sshd &> /dev/null && echo ï… # â›“
}
sshd1(){ # mouse-button 1 action for ssh daemon widget
    notifyservice sshd
}
sshd2(){
    toggleservice sshd
}

# -----------

sshtunnel(){ # ssh tunnels
    systemctl is-active sshtunnel &> /dev/null && echo ïƒ || echo "" # â›“
}
sshtunnel1(){ # mouse-button 1 action for ssh tunnel widget
    notifyservice sshtunnel
}
sshtunnel2(){
    toggleservice sshtunnel
}

# -----------

syncthing(){ # jupyterhub status
    systemctl is-active syncthing &> /dev/null && echo ï‡
}
syncthing1(){ # mouse-button 1 action for jupyterhub widget
    notifyservice syncthing
}
syncthing2(){
    toggleservice syncthing
}

# -----------

transmission(){
    pidof transmission-daemon &> /dev/null || return
    transmission-remote --list \
        | grep -v ID | grep -v Sum:\
        | awk  '{ print $2;}' \
        | sed '/100%/d' | sed 's/%//g' | sed 's|n/a||g' \
        | xargs python -c "from sys import argv; print(f'ï€™ {sum(int(i) for i in argv[1:])/len(argv[1:]):.0f}%')" 2> /dev/null
    if [ $? -ne 0 ]; then
        num=$(transmission-remote --list | grep -v ID | grep -v Sum: | wc -l)
        [ $num -gt 0 ] && echo "ğŸŒ±$num" && return # seeding
        echo ï€™ # active
    fi
}
transmission1(){
    notify-send "Transmission $(transmission | sed 's/ï€™/active: ï€™/g' | sed 's/ğŸŒ±/seeding: ğŸŒ±/g')" "$(transmission-remote --list)\n\nmiddle click to open transmission-cli\nright click to stop transmission-daemon"
}
transmission2(){
    $TERMINAL -e $HOME/.local/bin/transmission
}
transmission3(){
    kill -SIGTERM $(pidof transmission-daemon)
}


# -----------

volume(){ # volume
    string=$(amixer -D pulse get Master)
    if [[ $string == *"[on]"* ]]; then
        pct=$(echo $string | cut -d "[" -f2 | cut -d "%" -f1)
        [ "$pct" -gt 60 ] && echo "ğŸ”Š $pct%" && return
        [ "$pct" -gt 20 ] && echo "ğŸ”‰ $pct%" && return
        echo "ğŸ”ˆ $pct%"
        return
    fi
    echo ğŸ”‡
}
volume1(){ # mouse-button 1 action for volume widget
    string=$(amixer -D pulse get Master)
    percentage=$(echo $string | cut -d "[" -f2 | cut -d "]" -f1)
    notify-send "Volume $percentage" "\n\nï…‘ + ïƒ¾: volume up\nï…‘ + ï…†: volume down\nï…‘ + ïŒ½ + ï…†: mute"
}

# -----------

weather(){ # weather
    # reads from cache! Make sure you have it regularly update somewhere else.
    test -f ~/.cache/weatherreportshort && cat ~/.cache/weatherreportshort || echo ""
}
weather1(){ # mouse-button 1 action for weather widget
    # cat out the weather report, show only the first 7 lines and remove all colors
    report=$(cat ~/.cache/weatherreport | head -n 7 | sed 's/\x1b\[[0-9;]*m//g' | tail -n 6 | sed 's/\\/\\\\/g' | sed 's/â€•/-/g')
    notify-send "Weather" "$report\n\nmiddle click for full report"
}
weather2(){
    $TERMINAL -n float -f mono:12 -g 130x40+1130 -e update_weather --block
}

# -----------
wifi(){
    nmcli | grep "connected to" | sed 's/.*connected to //g'
}
wifi1(){
    network1
}




# Status Command
#--------------------------------------------------------------------------------
status
